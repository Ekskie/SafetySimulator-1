{% extends "base.html" %}

{% block title %}SafeZard - Performance Metrics{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        
        <!-- Header Section -->
        <div class="d-flex align-items-center mb-4 border-bottom border-secondary pb-3">
            <h1 class="mb-0 text-uppercase fw-bold" style="letter-spacing: 2px;">
                <span style="color: var(--safezard-green);">Performance</span> Metrics
            </h1>
            <div class="ms-auto text-muted small text-uppercase d-none d-md-block" id="system-status">
                <i class="bi bi-graph-up me-1"></i> System Analysis: <span class="text-white">Connecting...</span>
            </div>
        </div>

        <p class="lead mb-5 text-muted" style="max-width: 700px;">
            Review simulation performance data. Analyze proficiency trends, completion rates, and individual mission logs to optimize safety protocols.
        </p>

        <!-- KPI Cards (HUD Style) -->
        <div class="row g-4 mb-5">
            <!-- Total Modules Completed -->
            <div class="col-md-4">
                <div class="card h-100 bg-transparent border border-secondary position-relative overflow-hidden">
                    <div class="card-body text-center p-4">
                        <div class="text-uppercase text-muted small mb-2 ls-2">Modules Completed</div>
                        <h2 class="display-3 fw-bold text-white mb-0" id="total-completed">-</h2>
                        <div class="mt-2 text-success small">
                            <i class="bi bi-check-circle-fill me-1"></i> <span id="completion-rate">0%</span> of Database
                        </div>
                    </div>
                    <!-- Decorative Corner -->
                    <div style="position: absolute; bottom: 0; left: 0; width: 0; height: 0; 
                                border-bottom: 20px solid var(--safezard-green); 
                                border-right: 20px solid transparent; opacity: 0.6;"></div>
                </div>
            </div>

            <!-- Average Proficiency -->
            <div class="col-md-4">
                <div class="card h-100 bg-transparent border border-secondary position-relative overflow-hidden">
                    <div class="card-body text-center p-4">
                        <div class="text-uppercase text-muted small mb-2 ls-2">Avg. Proficiency</div>
                        <h2 class="display-3 fw-bold" style="color: var(--safezard-caution-yellow);" id="avg-score">-</h2>
                        <div class="mt-2 text-muted small">
                            Based on <span id="quiz-count">0</span> Assessments
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Training Time -->
            <div class="col-md-4">
                <div class="card h-100 bg-transparent border border-secondary position-relative overflow-hidden">
                    <div class="card-body text-center p-4">
                        <div class="text-uppercase text-muted small mb-2 ls-2">Sim Time Logged</div>
                        <h2 class="display-3 fw-bold text-info mb-0" id="total-time">-</h2>
                        <div class="mt-2 text-muted small">
                            Estimated Duration
                        </div>
                    </div>
                    <!-- Decorative Corner -->
                    <div style="position: absolute; top: 0; right: 0; width: 0; height: 0; 
                                border-top: 20px solid var(--safezard-green); 
                                border-left: 20px solid transparent; opacity: 0.6;"></div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card bg-dark bg-opacity-50 border-secondary shadow-lg h-100">
                    <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
                        <span class="text-uppercase fw-bold small text-muted ls-1"><i class="bi bi-activity me-2"></i>Proficiency Trend</span>
                    </div>
                    <div class="card-body">
                        <canvas id="scoreChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card bg-dark bg-opacity-50 border-secondary shadow-lg h-100">
                    <div class="card-header bg-transparent border-bottom border-secondary">
                        <span class="text-uppercase fw-bold small text-muted ls-1"><i class="bi bi-pie-chart me-2"></i>Sector Coverage</span>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div style="width: 100%; max-width: 250px;">
                            <canvas id="sectorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Logs Table -->
        <div class="card bg-dark bg-opacity-50 border-secondary shadow-lg">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <span class="text-uppercase fw-bold small text-muted ls-1"><i class="bi bi-list-columns-reverse me-2"></i>Recent Mission Logs</span>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle" style="background-color: transparent;">
                    <thead>
                        <tr class="text-uppercase small text-muted border-secondary">
                            <th class="ps-4 py-3">Timestamp</th>
                            <th class="py-3">Module</th>
                            <th class="py-3 text-center">Result</th>
                            <th class="py-3 text-end pe-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body" class="border-secondary">
                        <tr><td colspan="4" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm text-success" role="status"></div> Loading Data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const TOTAL_SCENARIOS = 8; // Baseline for completion calculation
    const statusEl = document.getElementById('system-status');
    let scoreChartInstance = null;
    let sectorChartInstance = null;

    // --- 1. Fetch Data from API ---
    fetch('/api/get_analytics')
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            processAnalyticsData(data);
        })
        .catch(err => {
            console.error("Fetch error:", err);
            // STRICT ERROR HANDLING: No Fallback
            statusEl.innerHTML = '<i class="bi bi-exclamation-triangle text-danger me-1"></i> System Analysis: <span class="text-danger">DATABASE CONNECTION FAILED</span>';
            
            // Clear stats to indicate no data
            document.getElementById('total-completed').innerText = 'ERR';
            document.getElementById('completion-rate').innerText = '-';
            document.getElementById('avg-score').innerText = 'ERR';
            document.getElementById('quiz-count').innerText = '-';
            document.getElementById('total-time').innerText = '-';

            // Show explicit error in table
            document.getElementById('logs-table-body').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-5 text-danger small text-uppercase">
                        <i class="bi bi-hdd-network-fill fs-1 mb-3 d-block"></i>
                        CRITICAL ERROR: Unable to retrieve performance metrics from database.<br>
                        Please check your network connection or contact system administrator.
                    </td>
                </tr>`;
        });

    function processAnalyticsData(data) {
        // Data Structure from API:
        // data.progress = [{ scenario_id, score, completed, completed_at }]
        // data.logs = [{ scenario_id, scenario_title, score, attempted_at }]

        const progressList = data.progress || [];
        const logsList = data.logs || [];

        // --- 2. Calculate Metrics ---
        let completedCount = 0;
        let totalScore = 0;
        let scoreCount = 0;
        let totalTime = 0;

        // Calculate Completed Modules
        progressList.forEach(item => {
            if (item.completed) completedCount++;
        });

        // Calculate Average Proficiency & Time from Logs
        // Sort logs by date (oldest to newest) for the chart
        logsList.sort((a, b) => new Date(a.attempted_at) - new Date(b.attempted_at));

        logsList.forEach(log => {
            // Ensure score is a number
            const s = parseInt(log.score || 0);
            totalScore += s;
            scoreCount++;
            
            // Estimate time: 10 mins per attempt (since we don't track duration yet)
            totalTime += 10; 
        });

        const avgScore = scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0;
        const completionRate = Math.round((completedCount / TOTAL_SCENARIOS) * 100);

        // --- 3. Update DOM Elements ---
        document.getElementById('total-completed').innerText = completedCount;
        document.getElementById('completion-rate').innerText = completionRate + '%';
        document.getElementById('avg-score').innerText = avgScore + '%';
        document.getElementById('quiz-count').innerText = scoreCount;
        document.getElementById('total-time').innerText = totalTime + 'm';

        // Update Status Indicator
        statusEl.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i> System Analysis: <span class="text-white">Active</span>';

        // --- 4. Render Table (Most recent first) ---
        const tableBody = document.getElementById('logs-table-body');
        // Reverse copy for table display
        const recentLogs = [...logsList].reverse().slice(0, 5); 

        if (recentLogs.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted small text-uppercase">No mission logs found. Initialize training to generate data.</td></tr>`;
        } else {
            tableBody.innerHTML = ''; // Clear loading
            recentLogs.forEach(log => {
                const date = new Date(log.attempted_at);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let score = parseInt(log.score || 0);
                let badgeClass = 'bg-secondary';
                if (score >= 80) badgeClass = 'bg-success text-white';
                else if (score >= 50) badgeClass = 'bg-warning text-dark';
                else badgeClass = 'bg-danger text-white';

                const row = `
                    <tr>
                        <td class="ps-4 text-muted font-monospace small">${formattedDate}</td>
                        <td class="fw-bold text-white text-uppercase">${log.scenario_title || log.scenario_id || 'Unknown Mission'}</td>
                        <td class="text-center">
                            <span class="badge ${badgeClass} rounded-0" style="min-width: 50px;">${score}%</span>
                        </td>
                        <td class="text-end pe-4">
                            <span class="text-muted small text-uppercase"><i class="bi bi-archive-fill me-1"></i> LOGGED</span>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- 5. Render Charts ---
        renderCharts(logsList, completedCount);
    }

    function renderCharts(logs, completedCount) {
        // Chart Configuration (Dark Theme)
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.font.family = "'Lexend', sans-serif";

        // --- Score Trend Chart ---
        const ctxScore = document.getElementById('scoreChart').getContext('2d');
        
        // Data for chart
        const labels = logs.map((_, i) => `Attempt ${i+1}`);
        const dataPoints = logs.map(r => parseInt(r.score || 0));

        // Gradient for line
        let gradient = ctxScore.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.5)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0.0)');

        if (scoreChartInstance) scoreChartInstance.destroy();

        scoreChartInstance = new Chart(ctxScore, {
            type: 'line',
            data: {
                labels: labels.length ? labels : ['Start'],
                datasets: [{
                    label: 'Proficiency Score (%)',
                    data: dataPoints.length ? dataPoints : [0],
                    borderColor: '#00ff88',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#000',
                    pointBorderColor: '#00ff88',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: '#00ff88',
                        bodyColor: '#fff',
                        borderColor: '#333',
                        borderWidth: 1,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // --- Sector Doughnut Chart ---
        // Mock distribution for now as we don't have sector data explicitly in analytics endpoint yet
        // We can assume a split based on total scenarios or just visual placeholder
        const ctxSector = document.getElementById('sectorChart').getContext('2d');
        
        if (sectorChartInstance) sectorChartInstance.destroy();

        sectorChartInstance = new Chart(ctxSector, {
            type: 'doughnut',
            data: {
                labels: ['Lab', 'Facility'],
                datasets: [{
                    data: [completedCount, Math.max(0, TOTAL_SCENARIOS - completedCount)], 
                    backgroundColor: [
                        '#00ff88', // Completed (Green)
                        '#2a2a2a'  // Remaining (Dark Grey)
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                cutout: '75%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label === 'Lab' ? 'Completed: ' + context.raw : 'Remaining: ' + context.raw;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}