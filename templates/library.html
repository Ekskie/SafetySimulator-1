{% extends "base.html" %}

{% block title %}SafeZard - Archives{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        
        <!-- Header Section -->
        <div class="d-flex align-items-center mb-4 border-bottom border-secondary pb-3">
            <h1 class="mb-0 text-uppercase fw-bold" style="letter-spacing: 2px;">
                <span style="color: var(--safezard-green);">Training</span> Archives
            </h1>
            <div class="ms-auto text-muted small text-uppercase d-none d-md-block" id="db-status-indicator">
                <i class="bi bi-database-fill me-1"></i> Accessing Records...
            </div>
        </div>
        
        <!-- Error Alert Container (Hidden by default) -->
        <div id="db-error-alert" class="alert alert-danger border border-danger d-none align-items-center mb-4" role="alert">
            <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
            <div>
                <h5 class="alert-heading text-uppercase fw-bold mb-1">Database Connection Failed</h5>
                <p class="mb-0 small">Unable to retrieve training records. Progress data displayed may be inaccurate or missing. Please verify network connection.</p>
            </div>
        </div>

        <p class="lead mb-5 text-muted" style="max-width: 700px;">
            Access the complete database of safety modules. Review completed missions, resume active simulations, or initiate new training protocols.
        </p>
        
        <!-- Search and Filter Control Panel -->
        <div class="card mb-5 shadow-lg" style="border-left: 4px solid var(--safezard-green);">
            <div class="card-header text-uppercase fw-bold small text-muted ls-1 border-bottom border-secondary">
                <i class="bi bi-sliders me-2"></i> Database Filters
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <!-- Search Input -->
                    <div class="col-lg-6">
                        <label class="text-uppercase small text-muted mb-1">Search Query</label>
                        <div class="input-group">
                            <span class="input-group-text  border-secondary text-success">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="search-input" class="form-control form-control-lg fw-bold" 
                                   placeholder="ENTER KEYWORDS..." style="text-transform: uppercase;">
                        </div>
                    </div>
                    
                    <!-- Environment Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label class="text-uppercase small text-muted mb-1">Sector</label>
                        <select class="form-select form-select-lg text-uppercase" id="workplace-filter">
                            <option value="all">All Sectors</option>
                            <option value="laboratory">Laboratory</option>
                            <option value="facility">Facility</option>
                        </select>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label class="text-uppercase small text-muted mb-1">Status</label>
                        <select class="form-select form-select-lg text-uppercase" id="status-filter">
                            <option value="all">All Records</option>
                            <option value="completed">Completed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="not-started">Not Started</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scenarios List / Data Grid -->
        <div class="row g-4" id="library-list">
            {% for scenario in scenarios %}
            <div class="col-md-6 col-lg-4 scenario-item" 
                 data-workplace="{{ scenario.workplace }}"
                 data-title="{{ scenario.title | lower }}"
                 data-status="not-started">
                
                <!-- Data Card -->
                <div class="card h-100 position-relative overflow-hidden library-card" 
                     style=" border: 1px solid rgba(255,255,255,0.1);">
                    
                    <!-- Decorative corner accent -->
                    <div style="position: absolute; top: 0; right: 0; width: 0; height: 0; 
                                border-top: 30px solid var(--safezard-green); 
                                border-left: 30px solid transparent; opacity: 0.8;"></div>

                    <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center py-3">
                        <span class="badge rounded-0 fw-normal ls-1 text-uppercase" 
                              style=" border: 1px solid rgba(255,255,255,0.2);">
                              <i class="bi {% if scenario.workplace == 'laboratory' %}bi-flask{% elif scenario.workplace == 'facility' %}bi-building-gear{% else %}bi-tree{% endif %} me-1"></i>
                              {{ scenario.workplace }}
                        </span>
                        
                        <!-- Dynamic Status Badge -->
                        <span class="status-badge badge rounded-0 text-uppercase fw-bold" 
                              style="color: #666; border: 1px solid #444;">
                            <i class="bi bi-circle-fill small me-1" style="font-size: 0.5rem;"></i> Not Started
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title text-uppercase fw-bold mb-3" style="letter-spacing: 1px; min-height: 3rem;">
                            {{ scenario.title }}
                        </h5>
                        <p class="card-text text-muted small border-start border-2 border-secondary ps-3 mb-4">
                            {{ scenario.description }}
                        </p>
                        
                        <!-- Stats Grid -->
                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <div class="bg-black bg-opacity-25 p-2 border border-dark text-center">
                                    <small class="d-block text-muted text-uppercase" style="font-size: 0.65rem;">Difficulty</small>
                                    <span class=" fw-bold small text-uppercase">{{ scenario.difficulty }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-black bg-opacity-25 p-2 border border-dark text-center">
                                    <small class="d-block text-muted text-uppercase" style="font-size: 0.65rem;">Est. Time</small>
                                    <span class=" fw-bold small">{{ scenario.duration }} min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent border-0 pt-0 pb-3">
                        <div class="d-grid gap-2">
                            <a href="/player/{{ scenario.id }}" class="btn btn-action text-uppercase fw-bold" 
                               style="background-color: transparent; border: 1px solid var(--safezard-green); color: var(--safezard-green); transition: all 0.2s;">
                               Initialize
                            </a>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="last-activity text-muted text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">
                                No Data Logged
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Empty State -->
            {% if not scenarios %}
            <div class="col-12">
                <div class="alert alert-dark border border-secondary d-flex align-items-center p-4">
                    <i class="bi bi-exclamation-triangle-fill text-warning fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-1 text-uppercase">Database Empty</h5>
                        <p class="mb-0 text-muted">No training modules currently loaded in the archives.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- No Search Results -->
        <div id="no-results" class="alert alert-dark border border-secondary mt-5 text-center" style="display: none;">
            <i class="bi bi-search text-muted fs-1 mb-3 d-block"></i>
            <h5 class="text-uppercase">No Matching Records Found</h5>
            <p class="text-muted">Adjust filter parameters and try again.</p>
        </div>
    </div>
</section>

<!-- Additional CSS for specific hover effects -->
<style>
    .library-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .library-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        border-color: var(--safezard-green) !important;
    }
    .btn-action:hover {
        background-color: var(--safezard-green) !important;
        color: #000 !important;
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // State to hold user progress
    let userProgressData = {};
    const dbStatusIndicator = document.getElementById('db-status-indicator');
    const dbErrorAlert = document.getElementById('db-error-alert');

    // 1. Fetch Progress from API
    async function fetchProgress() {
        try {
            // Update UI to show syncing
            if(dbStatusIndicator) dbStatusIndicator.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div> Syncing...';
            if(dbErrorAlert) dbErrorAlert.classList.add('d-none'); // Hide error if retrying

            const response = await fetch('/api/get_analytics');
            if (response.ok) {
                const data = await response.json();
                
                // Transform API list to Object map: { scenario_id: { ... } }
                if (data.progress) {
                    data.progress.forEach(item => {
                        userProgressData[item.scenario_id] = {
                            completed: item.completed,
                            percentComplete: item.score,
                            timestamp: item.completed_at
                        };
                    });
                }
                
                // Update UI for Success
                if(dbStatusIndicator) {
                    dbStatusIndicator.innerHTML = '<i class="bi bi-database-check me-1 text-success"></i> Database: Connected';
                    dbStatusIndicator.classList.remove('text-muted');
                }
                
                updateLibraryItems();
            } else {
                // STRICT ERROR: No Fallback
                console.warn('Failed to fetch library analytics');
                showDatabaseError();
            }
        } catch (error) {
            console.error('Error fetching progress:', error);
            showDatabaseError();
        }
    }

    // 2. Show Error State (Strict Mode)
    function showDatabaseError() {
        if(dbStatusIndicator) {
            dbStatusIndicator.innerHTML = '<i class="bi bi-hdd-network me-1 text-danger"></i> Connection Failed';
            dbStatusIndicator.classList.remove('text-muted');
            dbStatusIndicator.classList.add('text-danger');
        }
        if(dbErrorAlert) {
            dbErrorAlert.classList.remove('d-none');
            dbErrorAlert.classList.add('d-flex');
        }
        // We do NOT load localStorage data here. 
        // The list will remain with default "Not Started" status.
    }

    // 3. Update UI Elements based on Data
    function updateLibraryItems() {
        const scenarioItems = document.querySelectorAll('.scenario-item');
    
        scenarioItems.forEach(item => {
            const scenarioLink = item.querySelector('.btn-action');
            if (!scenarioLink) return;

            // Extract ID from href (e.g., /player/PC1 -> PC1)
            const parts = scenarioLink.getAttribute('href').split('/');
            const scenarioId = parts[parts.length - 1];

            const statusBadge = item.querySelector('.status-badge');
            const lastActivity = item.querySelector('.last-activity');
            const btnAction = item.querySelector('.btn-action');
            
            if (userProgressData[scenarioId]) {
                const scenarioProgress = userProgressData[scenarioId];
                
                // Update last activity with formatted date
                if (scenarioProgress.timestamp) {
                    const date = new Date(scenarioProgress.timestamp);
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    lastActivity.textContent = `LAST ACCESS: ${formattedDate}`;
                }
                
                // Update status badge and button
                if (scenarioProgress.completed) {
                    statusBadge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> COMPLETED';
                    statusBadge.style.color = 'var(--safezard-green)';
                    statusBadge.style.borderColor = 'var(--safezard-green)';
                    
                    btnAction.textContent = 'REVIEW MISSION';
                    btnAction.style.borderColor = 'var(--safezard-text)';
                    btnAction.style.color = 'var(--safezard-text)';
                    
                    // Set data attribute for filtering
                    item.dataset.status = 'completed';
                } else if (scenarioProgress.percentComplete > 0) {
                    statusBadge.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> IN PROGRESS';
                    statusBadge.style.color = 'var(--safezard-caution-yellow)';
                    statusBadge.style.borderColor = 'var(--safezard-caution-yellow)';
                    
                    btnAction.textContent = 'RESUME MISSION';
                    btnAction.style.borderColor = 'var(--safezard-caution-yellow)';
                    btnAction.style.color = 'var(--safezard-caution-yellow)';
                    
                    // Set data attribute for filtering
                    item.dataset.status = 'in-progress';
                }
            }
        });
        
        // Re-apply filters in case data changed visibility
        applyFilters();
    }
    
    // 4. Init
    fetchProgress();
    
    // Search and filtering functionality
    const searchInput = document.getElementById('search-input');
    const workplaceFilter = document.getElementById('workplace-filter');
    const statusFilter = document.getElementById('status-filter');
    const noResultsMessage = document.getElementById('no-results');
    
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const workplaceValue = workplaceFilter.value;
        const statusValue = statusFilter.value;
        
        let visibleCount = 0;
        
        const scenarioItems = document.querySelectorAll('.scenario-item');
        
        scenarioItems.forEach(item => {
            const matchesSearch = item.dataset.title.includes(searchTerm);
            const matchesWorkplace = (workplaceValue === 'all' || item.dataset.workplace === workplaceValue);
            const matchesStatus = (statusValue === 'all' || item.dataset.status === statusValue);
            
            if (matchesSearch && matchesWorkplace && matchesStatus) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
    }
    
    // Add event listeners
    searchInput.addEventListener('input', applyFilters);
    workplaceFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
});
</script>
{% endblock %}